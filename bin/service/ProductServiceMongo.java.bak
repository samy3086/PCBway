package service;

import model.Product;
import java.util.ArrayList;
// Uncomment these imports when MongoDB JAR files are added to lib/
// import database.DatabaseManager;
// import com.mongodb.client.MongoCollection;
// import org.bson.Document;
// import com.mongodb.client.MongoCursor;

/**
 * Product Service with MongoDB integration capability
 */
public class ProductServiceMongo {
    private ArrayList<Product> products = new ArrayList<>();
    // private DatabaseManager dbManager;
    private boolean useDatabase = true;

    public ProductServiceMongo() {
        // Initialize database connection when MongoDB JARs are available
         try {
            dbManager = DatabaseManager.getInstance();
            if (dbManager.testConnection()) {
                useDatabase = true;
               loadProductsFromDatabase();
                 System.out.println("Loaded products from MongoDB");
            }
         } catch (Exception e) {
            System.out.println("MongoDB not available, using default products");
             useDatabase = false;
            initializeDefaultProducts();
        // }
        
        initializeDefaultProducts();
    }
    
    private void initializeDefaultProducts() {
        products.add(new Product(
            "PCB Prototype",
            "images/pcb1.png",
            12.99,
            "2-layer PCB board"));

        products.add(new Product(
            "Solder Kit",
            "images/solder.png",
            8.50,
            "Complete soldering kit"));
            
        products.add(new Product(
            "Arduino Uno",
            "images/arduino.png",
            25.00,
            "Microcontroller board"));
            
        products.add(new Product(
            "Resistor Pack",
            "images/resistors.png",
            5.99,
            "Assorted resistor values"));
            
        products.add(new Product(
            "Breadboard",
            "images/breadboard.png",
            8.00,
            "Solderless prototyping board"));
    }
    
    // MongoDB methods (uncomment when JAR files are available)
    
    private void loadProductsFromDatabase() {
        try {
            MongoCollection<Document> productsCollection = dbManager.getProductsCollection();
            products.clear();
            
            try (MongoCursor<Document> cursor = productsCollection.find().iterator()) {
                while (cursor.hasNext()) {
                    Document doc = cursor.next();
                    Product product = new Product(
                        doc.getString("name"),
                        doc.getString("imagePath"),
                        doc.getDouble("price"),
                        doc.getString("description")
                    );
                    products.add(product);
                }
            }
            
            // If no products in database, add default ones
            if (products.isEmpty()) {
                initializeDefaultProductsInDatabase();
            }
        } catch (Exception e) {
            System.err.println("Error loading products from database: " + e.getMessage());
            initializeDefaultProducts();
        }
    }
    
    private void initializeDefaultProductsInDatabase() {
        try {
            MongoCollection<Document> productsCollection = dbManager.getProductsCollection();
            
            // Add default products to database
            Document[] defaultProducts = {
                new Document("name", "PCB Prototype")
                    .append("imagePath", "images/pcb1.png")
                    .append("price", 12.99)
                    .append("description", "2-layer PCB board")
                    .append("createdAt", new java.util.Date()),
                    
                new Document("name", "Solder Kit")
                    .append("imagePath", "images/solder.png")
                    .append("price", 8.50)
                    .append("description", "Complete soldering kit")
                    .append("createdAt", new java.util.Date()),
                    
                new Document("name", "Arduino Uno")
                    .append("imagePath", "images/arduino.png")
                    .append("price", 25.00)
                    .append("description", "Microcontroller board")
                    .append("createdAt", new java.util.Date()),
                    
                new Document("name", "Resistor Pack")
                    .append("imagePath", "images/resistors.png")
                    .append("price", 5.99)
                    .append("description", "Assorted resistor values")
                    .append("createdAt", new java.util.Date()),
                    
                new Document("name", "Breadboard")
                    .append("imagePath", "images/breadboard.png")
                    .append("price", 8.00)
                    .append("description", "Solderless prototyping board")
                    .append("createdAt", new java.util.Date())
            };
            
            for (Document product : defaultProducts) {
                productsCollection.insertOne(product);
            }
            
            // Reload products after insertion
            loadProductsFromDatabase();
            
        } catch (Exception e) {
            System.err.println("Error initializing default products in database: " + e.getMessage());
        }
    }
    
    public void addProduct(Product product) {
        products.add(product);
        
        if (useDatabase) {
            try {
                MongoCollection<Document> productsCollection = dbManager.getProductsCollection();
                
                Document productDoc = new Document("name", product.getName())
                        .append("imagePath", product.getImagePath())
                        .append("price", product.getPrice())
                        .append("description", product.getDescription())
                        .append("createdAt", new java.util.Date());
                
                productsCollection.insertOne(productDoc);
            } catch (Exception e) {
                System.err.println("Error adding product to database: " + e.getMessage());
            }
        }
    }
    

    public ArrayList<Product> getAllProducts() {
        return products;
    }
    
    public Product getProductByName(String name) {
        for (Product product : products) {
            if (product.getName().equalsIgnoreCase(name)) {
                return product;
            }
        }
        return null;
    }
    
    public ArrayList<Product> searchProducts(String query) {
        ArrayList<Product> results = new ArrayList<>();
        for (Product product : products) {
            if (product.getName().toLowerCase().contains(query.toLowerCase()) ||
                product.getDescription().toLowerCase().contains(query.toLowerCase())) {
                results.add(product);
            }
        }
        return results;
    }
}